---
import CurrentYear from "../reactComponents/CurrentYear";
import Layout from "../layouts/Layout.astro";
import apiData from "../data/api-data";
import masterQuestionsJson from "../data/masterQuestions.json";
import { createBigObjectDataForBuildTime, createQuestionUrl, getFullUrl, mapApiData } from "../utils/utils";
import type { ApiDataItem, QuestionPageData } from "../store/store";
import AnswerAbc from "../reactComponents/AnswerAbc";
import AnswerYesNo from "../reactComponents/AnswerYesNo";
import Media from "../reactComponents/Media";
import PrevNextQuestion from "../reactComponents/PrevNextQuestion";
import QuestionText from "../reactComponents/QuestionText";
import { URLS } from "../urls/urls";

interface ArrayToGeneratePages {
  params: {
    question: string;
  };
  props: {
    questionPageData: QuestionPageData;
  };
}

export async function getStaticPaths() {
  const bigData = createBigObjectDataForBuildTime(apiData);
  const explanations = masterQuestionsJson.allQuestions;

  const { allCategories } = bigData;

  const arrayToGeneratePages: ArrayToGeneratePages[] = [];

  // allCategories.forEach((category) => {
  ["a", "b"].forEach((category) => {
    const arrayToGeneratePagesPerCategory = mapApiData(apiData as ApiDataItem[])
      .filter((q) => q.categories.includes(category))
      .map((q) => {
        const expls = explanations.find((e) => e.id === q.id)?.expl || [];
        const lows = explanations.find((e) => e.id === q.id)?.low || [];

        const questionPageData: QuestionPageData = {
          ...q,
          slug: createQuestionUrl(q, category),
          category,
          prevSlug: "#",
          nextSlug: "#",
          expls: typeof expls === "string" ? [expls] : expls,
          lows,
        };

        return {
          params: { question: createQuestionUrl(q, category) },
          props: { questionPageData, allCategories },
        };
      });

    arrayToGeneratePages.push(...arrayToGeneratePagesPerCategory);
  });

  const arrayToGeneratePagesWithPrevNext = arrayToGeneratePages.map((page, index) => {
    const prevPage = arrayToGeneratePages[index - 1];
    const nextPage = arrayToGeneratePages[index + 1];

    return {
      ...page,
      props: {
        ...page.props,
        questionPageData: {
          ...page.props.questionPageData,
          prevSlug: prevPage ? getFullUrl(prevPage.params.question) : null,
          nextSlug: nextPage ? getFullUrl(nextPage.params.question) : null,
        },
      },
    };
  });

  return arrayToGeneratePagesWithPrevNext;
}

const questionPageData: QuestionPageData = Astro.props.questionPageData;
const allCategories = Astro.props.allCategories;
const { id, text, category, score, media, isVideo, prevSlug, nextSlug, expls, lows } = questionPageData;

const currentYear = new Date().getFullYear();
---

<Layout title={`${text} | Darmowe testy na prawo jazdy ${currentYear}`}>
  <div class="row">
    <div class="col-12 col-lg-6">
      <div class="QUESTION-INFO row mb-2 text-center">
        <div class="col-3">
          <div class="text-secondary h-100 d-flex justify-content-center align-items-center">
            <span>{id}</span>
          </div>
        </div>
        <div class="col-3">
          <div class="text-secondary h-100 d-flex justify-content-center align-items-center">
            <span>kat: {category.toUpperCase()}</span>
          </div>
        </div>
        <div class="col-3">
          <div class="text-secondary h-100 d-flex justify-content-center align-items-center">
            <span>pkt: {score}</span>
          </div>
        </div>

        <div class="col-3">
          <div class="text-secondary h-100 d-flex justify-content-center align-items-center">
            <span class="click-to-go-full-screen"></span>
          </div>
        </div>
      </div>

      <Media client:load text={text} media={media} size="large" showControls={true} />

      <QuestionText client:load question={questionPageData} />

      <AnswerAbc client:load question={questionPageData} />

      <AnswerYesNo client:load question={questionPageData} />

      <PrevNextQuestion client:load question={questionPageData} />

      <!-- <div class="row mb-3">
        <div class="col">
          <div class="small text-center">
            <p class="mb-0"><strong> Oceń znajomość tego pytania:</strong></p>
            <p>(będziesz mógł przeglądać ocenione pytania)</p>
          </div>
        </div>
      </div> -->

      <!-- <div class="row mb-3">
         <div class="col">
          <h2>Twoje postępy w nauce:</h2>
          <a href="#" class="btn btn-success w-100 d-block mb-2"
            >Dobrze odpowiedziałeś na 0 pytań.
            <u>zobacz.</u>
          </a>
          <a href="#" class="btn btn-danger w-100 d-block mb-2"
            >Średnio odpowiedziałeś na 0 pytań.
            <u>zobacz.</u>
          </a>
        </div>
      </div> -->

      <div class="row mb-3">
        <div class="col text-start">
          <h2>Wyjaśnienie pytania z testów na prawo jazdy:</h2>

          <div>
            <!-- <p class="small">expls.length === {expls.length}</p> -->
            <div>{expls.map((expl) => <p>{expl}</p>)}</div>
          </div>

          <div>
            <!-- <p class="small">lows.length === {lows.length}</p> -->

            {
              lows.map((article) => {
                return (
                  <div class="container my-3">
                    <p>{article.title}</p>
                    {article.artContent.map((content: any) => (
                      <div class="my-4">
                        
                        <p><span class="fw-bold">{content.title}</span> <span>{content.text}</span></p>
                      </div>
                    ))}
                  </div>
                );
              })
            }

            <!-- <pre>{JSON.stringify(lows,null,2)}</pre> -->
          </div>
        </div>

        

        <!-- <div class="row mb-3">
        <div class="col text-start">
          <h2>Wyjaśnienie pytania z testów na prawo jazdy:</h2>

          <div>
            <p>
              Przejeżdżając obok tramwaju który zatrzymał się na przystanku
              należy ustąpić pierwszeństwa pieszym chcącym wsiąść i wysiąść z
              pojazdu.
            </p>
          </div>
          <p></p>
          <p>ustawa108 art3 art3ust1pktart26ust6</p>
          <div>[object Object]</div>
        </div>
      </div> -->

        <div class="row">
          <div class="col">
            <p>
              To pytanie należy do kategorii <strong>{category.toUpperCase()},</strong>
              testów na prawo jazdy z <CurrentYear /> roku.
            </p>
            <p>
              <a href={URLS.DRIVING_LICENSE_CATEGIRIES} class="text-decoration-none">
                Zmień domyślną kategorię pytań z testów na prawo jazdy jaką chcesz się uczyć!
              </a>
            </p>
          </div>
        </div>

        <!-- <div class="row">
        <div class="col">
          <h2>Szczegóły dotyczące tego pytania testowego:</h2>
          <div class="table-responsive">
            <table class="table table-dark">
              <caption
                >Powyższa tabela przedstawia szegółowe informacje dotyczące
                pytania z testów na prawo jazdy. Informacje są aktualne w lutym
                2023 roku.</caption
              >
              <thead>
                <tr>
                  <th scope="col">Co?</th>
                  <th scope="col">Info!</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">Id w bazie danych ministerstwa transportu</th>
                  <td> <span>id</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div> -->

        <!-- ROW ROW -->
        <div class="row">
          <div class="col">
            <div class="mt-5 pb-5 text-start">
              <p>
                Pamiętaj, że jedno konkretne pytanie z
                <strong> testów na prawo jazdy aktualnych w <CurrentYear client:load /></strong>
                może należeć do wielu różnych kategorii prawa jazdy. To pytanie testowe należy to kategorii {
                  questionPageData.categories.join(", ").toUpperCase()
                }
              </p>
              <p>
                Wszystkie dostępne kategorie pytań z testów na prawo jazdy w lutym <CurrentYear client:load /> to
                <strong>{allCategories.join(", ").toUpperCase()}</strong>
              </p>
            </div>
          </div>
        </div>

        <!-- <div class="row mb-3">
        <div class="col">
          <h2>Zobacz też inne pytania testowe!</h2>
          ...
        </div>
      </div> -->

      <p>
        <a
          href={`https://poznaj-testy.pl/${createQuestionUrl(questionPageData, "b")}`}
          target="_blank"
          rel="noopener noreferrer">{`https://poznaj-testy.pl/${createQuestionUrl(questionPageData, "b")}`}</a
        >
      </p>
      </div>
    </div>
  </div>

  <style is:global>
    /* webkit requires explicit width, height = 100% of sceeen */
    /* webkit also takes margin into account in full screen also - so margin should be removed (otherwise black areas will be seen) */

    .full-screen-wrapper:-webkit-full-screen {
      overflow: scroll !important;
      background-color: white !important;
      margin: 0;
      width: 100%;
      height: 100%;
      padding: 0.5rem;
      padding-top: 4rem;
    }

    .full-screen-wrapper:-moz-full-screen {
      overflow: scroll !important;
      background-color: white !important;
      margin: 0;
      width: 100%;
      height: 100%;
      padding: 0.5rem;
      padding-top: 4rem;
    }

    .full-screen-wrapper:-ms-fullscreen {
      overflow: scroll !important;
      background-color: white !important;
      margin: 0;
      width: 100%;
      height: 100%;
      padding: 0.5rem;
      padding-top: 4rem;
    }

    .full-screen-wrapper:fullscreen {
      overflow: scroll !important;
      background-color: white !important;
      margin: 0;
      width: 100%;
      height: 100%;
      padding: 0.5rem;
      padding-top: 4rem;
    }

    .blinking {
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.1;
      }
    }
  </style>

  <script>
    const fullScreenButtons = document.querySelectorAll(".click-to-go-full-screen") as NodeListOf<HTMLElement>;

    fullScreenButtons.forEach((fullScreenButton) => {
      fullScreenButton.addEventListener("click", () => {
        // DOM element which needs to enter fullscreen mode
        const element = document.querySelector(".full-screen-wrapper");

        console.log("go full screen");

        element
          ?.requestFullscreen()
          .then(function () {
            // element has entered fullscreen mode successfully
          })
          .catch(function (error) {
            // element could not enter fullscreen mode
            // error message
            console.log(error.message);
          });
      });
    });
  </script>
</Layout>
